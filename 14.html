<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>èˆªç®¡ AI å•ç­” - å…¨åŠŸèƒ½å„ªåŒ–ç‰ˆ</title>
<style>
body{font-family:"Noto Sans TC",system-ui;margin:0;background:#f4f7fb;color:#0f172a}
.wrap{max-width:960px;margin:40px auto;padding:20px}
.card{background:#fff;padding:20px;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,0.08)}
h1{margin:0 0 6px;font-size:22px}
.muted{color:#64748b;font-size:13px;margin-bottom:16px}
label{font-weight:600;display:block;margin:12px 0 6px}
select,input,textarea,button{width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:15px}
textarea{resize:vertical;min-height:120px}
button{cursor:pointer;font-weight:600}
.btn{background:#2563eb;color:#fff;border:none}
.btn:hover{background:#1e4fd7}
.btn.secondary{background:#475569}
.btn.danger{background:#b91c1c}
pre{background:#f1f5f9;padding:12px;border-radius:8px;white-space:pre-wrap;word-break:break-word;min-height:80px}
.small{font-size:13px;color:#64748b;margin-top:10px}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.history{margin-top:14px;border-top:1px solid #cbd5e1;padding-top:12px}
.history-item{background:#f9fafb;padding:10px;border-radius:8px;margin-bottom:8px}
.status{font-size:13px;color:#64748b;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>èˆªç®¡ AI å•ç­”</h1>
    <div class="muted">å¯è¼¸å…¥å•é¡Œ â†’ AI å›ç­”ï¼ˆæ•™å­¸/ç¤ºç¯„ç”¨é€”ï¼‰</div>

    <label>OpenAI API Keyï¼ˆå¯ç•™ç©ºä½¿ç”¨æ¨¡æ“¬æ¨¡å¼ï¼‰</label>
    <input id="apiKey" type="password" placeholder="sk-..." />

    <label>ä¸»é¡Œ</label>
    <select id="topic"></select>

    <label>ç›®æ¨™</label>
    <select id="goal"></select>

    <label>ä½ çš„å•é¡Œ</label>
    <textarea id="question" placeholder="ä¾‹å¦‚ï¼šå¦‚ä½•æ”¹å–„é›¢å ´é«˜å³°å»¶èª¤ï¼Ÿ"></textarea>

    <div class="row">
      <button id="askBtn" class="btn">é€å‡ºä¸¦å–å¾—å›ç­”</button>
      <button id="mockBtn" class="btn secondary">æ¨¡æ“¬å›ç­”</button>
      <button id="stopBtn" class="btn secondary">åœæ­¢å‹•ç•«</button>
      <button id="speakBtn" class="btn secondary">æœ—è®€å›ç­”</button>
      <button id="downloadBtn" class="btn secondary">ä¸‹è¼‰å ±å‘Š</button>
      <button id="clearBtn" class="btn danger">æ¸…é™¤</button>
    </div>

    <label>AI å›è¦†</label>
    <pre id="answer">å°šç„¡å›è¦†</pre>
    <div id="status" class="status"></div>

    <div class="history">
      <div class="small">æ­·å²ç´€éŒ„ï¼ˆæœ€è¿‘ 5 ç­†ï¼‰</div>
      <div id="historyList"></div>
    </div>

    <div class="small">
      <div class="danger">âš ï¸ æ³¨æ„ï¼š</div>
      åƒ…ä¾›æ•™å­¸ã€è¨­è¨ˆèˆ‡ç ”ç©¶ç”¨é€”ï¼Œè«‹å‹¿ç”¨æ–¼å³æ™‚èˆªç®¡æ±ºç­–ã€‚
    </div>
  </div>
</div>

<script>
// ----- ä¸»é¡Œèˆ‡ç›®æ¨™æ¨è–¦ -----
const topicEl = document.getElementById('topic');
const goalEl = document.getElementById('goal');
const topics = ["èˆªç®¡ä½œæ¥­æµç¨‹","èˆªç­åˆ†é…èˆ‡æµé‡ç®¡ç†","å¡”è‡º/å€åŸŸå”èª¿","èˆªç®¡ç³»çµ±è¨­è¨ˆ (ATM/TBO/Trajectories)","å®‰å…¨äº‹ä»¶èª¿æŸ¥èˆ‡ Root Cause","è¨“ç·´èˆ‡è€ƒæ ¸"];
const goals = ["ç°¡æ½”è§£é‡‹æ ¸å¿ƒæ¦‚å¿µï¼ˆçµ¦å­¸ç”Ÿï¼‰","æ‰¾å‡ºç³»çµ±ç“¶é ¸ä¸¦æå‡ºæ”¹å–„å»ºè­°ï¼ˆå·¥ç¨‹å‘ï¼‰","çµ¦å‡ºé¡Œç›®æ¸¬è©¦/ç·´ç¿’èˆ‡ç­”æ¡ˆï¼ˆæ•™å­¸å‘ï¼‰","ç”¢å‡º SOP è‰æ¡ˆï¼ˆè¡Œæ”¿å‘ï¼‰"];
topics.forEach(t=>topicEl.add(new Option(t,t)));
goals.forEach(g=>goalEl.add(new Option(g,g)));

// DOM
const questionEl = document.getElementById('question');
const askBtn = document.getElementById('askBtn');
const mockBtn = document.getElementById('mockBtn');
const stopBtn = document.getElementById('stopBtn');
const speakBtn = document.getElementById('speakBtn');
const downloadBtn = document.getElementById('downloadBtn');
const clearBtn = document.getElementById('clearBtn');
const answerEl = document.getElementById('answer');
const statusEl = document.getElementById('status');
const historyList = document.getElementById('historyList');
const apiKeyEl = document.getElementById('apiKey');

let typingTimer=null;
let lastText="";

// ----- Prompt å»ºæ§‹ -----
function buildPrompt(){
  return `ä½ æ˜¯å…·æœ‰15å¹´èˆªç®¡ç¶“é©—çš„å°ˆå®¶ï¼Œç†Ÿæ‚‰å¡”è‡ºã€å€åŸŸèˆ‡æµé‡ç®¡ç†åŠç³»çµ±å·¥ç¨‹ã€‚`+
         `è«‹é‡å°ä»¥ä¸‹å•é¡Œæä¾›æ¸…æ™°ã€å¯åŸ·è¡Œçš„å›ç­”ï¼ŒåŒ…å«ï¼š(1)æ ¸å¿ƒçµè«– (2)é—œéµå‡è¨­ (3)å»ºè­°æ­¥é©Ÿ (4)KPI (5)é¢¨éšªã€‚\n\n`+
         `ä¸»é¡Œï¼š${topicEl.value}\nç›®æ¨™ï¼š${goalEl.value}\nå•é¡Œï¼š${questionEl.value}`;
}

// ----- é€å­—å‹•ç•«é¡¯ç¤º -----
function typeWriter(el,text,speed=15){
  el.textContent=""; let i=0;
  clearInterval(typingTimer);
  typingTimer=setInterval(()=>{
    el.textContent+=text.charAt(i);
    i++;
    if(i>=text.length) clearInterval(typingTimer);
  },speed);
  lastText=text;
}
stopBtn.onclick=()=>{clearInterval(typingTimer); answerEl.textContent=lastText;};

// ----- èªéŸ³æœ—è®€ -----
speakBtn.onclick=()=>{
  const text=answerEl.textContent;
  if(!text) return alert("æ²’æœ‰å›ç­”å¯æœ—è®€");
  const utter=new SpeechSynthesisUtterance(text);
  utter.lang='zh-TW';
  speechSynthesis.speak(utter);
};

// ----- æ¨¡æ“¬å›ç­” -----
function mockAnswer(){
  return `ï¼ˆæ¨¡æ“¬å›è¦†ï¼‰
æ ¸å¿ƒçµè«–ï¼šå¯é€éå‹•æ…‹æµé‡åˆ†æµæ¸›å°‘é«˜å³°å»¶èª¤ç´„15%ã€‚
å‡è¨­ï¼šæµé‡è³‡æ–™æº–ç¢ºä¸”å…·å½ˆæ€§ã€‚
å»ºè­°æ­¥é©Ÿï¼š
1. å³æ™‚ç›£æ§èˆªç­åºåˆ—ä¸¦å„ªåŒ–æ’åºï¼›
2. ä¸­æœŸå°å…¥AIé æ¸¬æµé‡ï¼›
3. é•·æœŸæ¨å‹•TBOèˆªè·¡ç®¡ç†ã€‚
KPIï¼šå¹³å‡é›¢å ´å»¶èª¤ã€èˆªç­ååç‡ã€‚
é¢¨éšªï¼šæ•¸æ“šä¸å…¨å°è‡´æ±ºç­–åå·®ã€‚`;
}

// ----- æ­·å²ç´€éŒ„ -----
let history=[];
function addHistory(question,answer){
  history.unshift({q:question,a:answer});
  if(history.length>5) history.pop();
  renderHistory();
}
function renderHistory(){
  historyList.innerHTML="";
  history.forEach(h=>{
    const div=document.createElement('div');
    div.className='history-item';
    div.innerHTML=`<b>Q:</b> ${h.q}<br><b>A:</b> ${h.a}`;
    historyList.appendChild(div);
  });
}

// ----- ä¸‹è¼‰å ±å‘Š -----
downloadBtn.onclick=()=>{
  if(!lastText) return alert("æ²’æœ‰å›ç­”å¯ä¸‹è¼‰");
  const md=`# èˆªç®¡ AI å•ç­”å ±å‘Š\n\n**ä¸»é¡Œ**: ${topicEl.value}\n**ç›®æ¨™**: ${goalEl.value}\n**å•é¡Œ**:\n${questionEl.value}\n\n**AI å›ç­”**:\n${lastText}`;
  const blob=new Blob([md],{type:'text/markdown'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='atm_ai_report.md';
  a.click();
  URL.revokeObjectURL(a.href);
};

// ----- æ¸…é™¤ -----
clearBtn.onclick=()=>{
  answerEl.textContent="å°šç„¡å›è¦†";
  statusEl.textContent="";
  questionEl.value="";
};

// ----- å‘¼å« OpenAI API -----
async function callOpenAI(prompt,apiKey){
  const res=await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{"Content-Type":"application/json","Authorization":"Bearer "+apiKey},
    body:JSON.stringify({
      model:"gpt-4o-mini",
      messages:[
        {role:"system",content:"ä½ æ˜¯èˆªç®¡é ˜åŸŸçš„å°ˆå®¶ï¼Œè«‹æä¾›æ¸…æ™°å¯åŸ·è¡Œå›ç­”"},
        {role:"user",content:prompt}
      ],
      temperature:0.3,
      max_tokens:800
    })
  });
  if(!res.ok){ const txt=await res.text(); throw new Error(`HTTP ${res.status}: ${txt}`);}
  const data=await res.json();
  return data.choices?.[0]?.message?.content?.trim() || "[æœªå–å¾—å›è¦†]";
}

// ----- é€å‡ºå•é¡Œäº‹ä»¶ -----
askBtn.onclick=async()=>{
  if(!questionEl.value.trim()) return alert("è«‹è¼¸å…¥å•é¡Œ");
  const prompt=buildPrompt();
  const key=apiKeyEl.value.trim();
  if(!key) return alert("è«‹è¼¸å…¥ API Key æˆ–ä½¿ç”¨æ¨¡æ“¬æ¨¡å¼");
  statusEl.textContent="âŒ› æ­£åœ¨å–å¾— AI å›è¦†...";
  answerEl.textContent="";
  try{
    const reply=await callOpenAI(prompt,key);
    typeWriter(answerEl,reply);
    statusEl.textContent="âœ… å®Œæˆ";
    addHistory(questionEl.value,reply);
  }catch(e){
    statusEl.textContent="âŒ éŒ¯èª¤ï¼š" + e.message;
    answerEl.textContent="";
  }
};

// ----- æ¨¡æ“¬æ¨¡å¼äº‹ä»¶ -----
mockBtn.onclick=()=>{
  const reply=mockAnswer();
  typeWriter(answerEl,reply);
  statusEl.textContent="ğŸ’¡ æ¨¡æ“¬å›ç­”å®Œæˆ";
  addHistory(questionEl.value||"[æ¨¡æ“¬å•é¡Œ]",reply);
};
</script>
</body>
</html>
